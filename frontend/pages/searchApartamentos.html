<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UniMove | Search by Degree</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <style>
      .search-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        background: #f9fafc;
      }

      .search-card {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        max-width: 900px;
        width: 100%;
        padding: 40px;
        text-align: center;
        border-top: 6px solid #1a4d8f;
      }

      .search-card h2 {
        color: #1a4d8f;
        font-size: 1.9rem;
        margin-bottom: 10px;
      }

      .search-card p {
        color: #555;
        font-size: 1rem;
        margin-bottom: 30px;
      }

      .search-box {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .search-box input {
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #ccc;
        min-width: 260px;
        font-size: 1rem;
      }

      .search-box button {
        background-color: #1a4d8f;
        color: #fff;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
      }

      .search-box button:hover {
        background-color: #153a6c;
      }

      .checkbox-container {
        margin-top: 10px;
        font-size: 0.95rem;
        color: #444;
      }

      .results-card {
        background: #fff;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        max-width: 1000px;
        margin: 40px auto;
      }

      .results-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 20px;
      }

      .university-card {
        background-color: #ffffff;
        border: 1px solid #e5e5e5;
        border-radius: 14px;
        padding: 22px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        transition: 0.3s;
      }

      .university-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <h1 class="logo">
        <img
          src="../assets/svgs/logo.svg"
          style="width: 36px; height: 36px"
        />UniMove
      </h1>

      <ul class="menu">
        <li class="dropdown">
          <a href="#">Universities</a>
          <ul class="dropdown-content">
            <li><a href="universidades.html">Search on Map</a></li>
            <li><a href="searchByDegree.html">Search by Degree</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Moving</a>
          <ul class="dropdown-content">
            <li><a href="mapaapartamentos.html">Apartments</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Students</a>
          <ul class="dropdown-content">
            <li><a href="../index.html">Internships</a></li>
            <li><a href="studentLife.html">Study Section</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Health</a>
          <ul class="dropdown-content">
            <li><a href="biomedical.html">Health</a></li>
            <li><a href="mapclinics.html">Clinical Maps</a></li>
          </ul>
        </li>
      </ul>

      <div class="nav-right">
        <a href="../index.html">
          <img src="../assets/svgs/home.svg" class="home-button"
        /></a>

        <li class="user-section">
          <span id="user-name" style="font-weight: bold; color: #5a7c99"></span>
          <button id="logout" class="boton" style="display: none">
            <img src="../assets/svgs/logout.svg" />
          </button>
        </li>
      </div>
    </nav>

  <main>
    <section class="search-section">
      <div class="search-card">
        <h2>Find Apartments by Price and Location</h2>
        <p>Enter the neighborhood and budget to discover apartments that fit your needs :)</p>

        <div class="search-box">
          <input
            type="text"
            id="barrioInput"
            placeholder="Example: Centro, Boadilla, Valdemoro..."
          />
          <input
            type="number"
            id="precioInput"
            placeholder="Max. price (‚Ç¨)"
            min="0"
          />
          <button id="searchBtn">Search</button>
        </div>

        <!-- Opcional: ampliar coincidencias (ilike ya ayuda) -->
        <div class="checkbox-container">
          <label>
            <input type="checkbox" id="includeSimilar" />
            <span>Also include broadly-matching neighborhoods</span>
          </label>
        </div>
      </div>
    </section>

    <section class="results-card" id="resultsCard" style="display: none">
      <div id="resultsList" class="results-list"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="../assets/svgs/logo.svg" alt="MotivSMA Logo" />
        <span>UniMove</span>
      </div>
      <div class="footer-links">
        <a href="#">About</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Contact</a>
      </div>
      <div class="footer-copy">
        <p>
          &copy; 2025 UniMove | Built with ‚ù§Ô∏è for students around the world
        </p>
      </div>
    </div>
  </footer>

  <script>
    const searchBtn = document.getElementById("searchBtn");
    const barrioInput = document.getElementById("barrioInput");
    const precioInput = document.getElementById("precioInput");
    const resultsList = document.getElementById("resultsList");
    const resultsCard = document.getElementById("resultsCard");
    const includeSimilar = document.getElementById("includeSimilar");

    // Renderiza tarjetas de apartamentos
    function renderApartments(apartments) {
      resultsCard.style.display = "block";
      resultsList.innerHTML = "";

      if (!Array.isArray(apartments) || apartments.length === 0) {
        resultsList.innerHTML = "<p>No apartments found for this search.</p>";
        return;
      }

      apartments.forEach((a) => {
        const card = document.createElement("div");
        card.className = "apartment-card";
        card.innerHTML = `
          <h3 style="color:#1a4d8f; margin-bottom:10px; font-size:1.2rem;">
            üè† ${a.titulo ?? "Apartment"}
          </h3>
          <p><strong>Neighborhood:</strong> ${a.barrio ?? "N/A"}</p>
          <p><strong>Price:</strong> ${a.precio ?? "N/A"} ‚Ç¨</p>
          <p><strong>Size:</strong> ${a.tamano_m2 ?? "N/A"} m¬≤</p>
          <p><strong>Furnished:</strong> ${a.amueblado ? "Yes" : "No"}</p>
          <p><strong>Location:</strong> ${a.latitud ?? "?"}, ${a.longitud ?? "?"}</p>
        `;
        resultsList.appendChild(card);
      });
    }


    function buildUrl(barrio, precio) {

      if (barrio && precio) {

        return `http://127.0.0.1:8080/get_apartments_by_barrio_price?barrio=${encodeURIComponent(
          barrio
        )}&presupuesto=${precio}`;
      }

      if (barrio) {
        return `http://127.0.0.1:8080/get_apartments_by_barrio/${encodeURIComponent(
          barrio
        )}`;
      }

      if (precio) {
        return `http://127.0.0.1:8080/get_apartments_by_price/${precio}`;
      }

      return "http://127.0.0.1:8080/get_apartments";
    }

    async function searchApartments() {
      const barrio = barrioInput.value.trim();
      const precio = precioInput.value.trim();


      if (!barrio && !precio) {
        resultsCard.style.display = "block";
        resultsList.innerHTML =
          "<p style='color:red;'>Please enter a neighborhood and/or a maximum price.</p>";
        return;
      }

      const url = buildUrl(barrio, precio);

      try {
        const res = await fetch(url);
        const data = await res.json();


        if (includeSimilar.checked && barrio) {

          const barrioShort = barrio.split(",")[0].split(" ").slice(0, 1).join(" ");
          if (barrioShort && barrioShort.toLowerCase() !== barrio.toLowerCase()) {
            const res2 = await fetch(
              `http://127.0.0.1:8080/get_apartments_by_barrio/${encodeURIComponent(
                barrioShort
              )}`
            );
            const data2 = await res2.json();

            const seen = new Set((data || []).map((x) => x.id));
            data2.forEach((x) => { if (!seen.has(x.id)) data.push(x); });
          }
        }

        renderApartments(data);
      } catch (err) {
        console.error("Error fetching apartments:", err);
        resultsCard.style.display = "block";
        resultsList.innerHTML =
          "<p style='color:red;'>Error connecting to the server.</p>";
      }
    }

    searchBtn.addEventListener("click", searchApartments);
    barrioInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchApartments();
    });
    precioInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchApartments();
    });
  </script>
</body>
