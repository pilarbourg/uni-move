<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UniMove | Universities Map</title>
    <link rel="stylesheet" href="../css/mapclinics.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  </head>
  <body>
    <nav class="navbar">
      <h1 class="logo">
        <img
          src="../assets/svgs/logo.svg"
          style="width: 36px; height: 36px"
        />UniMove
      </h1>

      <ul class="menu">
        <li class="dropdown">
          <a href="#">Universities</a>
          <ul class="dropdown-content">
            <li><a href="universidades.html">Search on Map</a></li>
            <li><a href="searchByDegree.html">Search by Degree</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Moving</a>
          <ul class="dropdown-content">
            <li><a href="mapaapartamentos.html">Apartments</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Students</a>
          <ul class="dropdown-content">
            <li><a href="../index.html">Internships</a></li>
            <li><a href="studentLife.html">Study Section</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Health</a>
          <ul class="dropdown-content">
            <li><a href="biomedical.html">Health</a></li>
            <li><a href="mapclinics.html">Clinical Maps</a></li>
          </ul>
        </li>
      </ul>

      <div class="nav-right">
        <a href="../index.html">
          <img src="../assets/svgs/home.svg" class="home-button"
        /></a>

        <li class="user-section">
          <span id="user-name" style="font-weight: bold; color: #5a7c99"></span>
          <button id="logout" class="boton" style="display: none">
            <img src="../assets/svgs/logout.svg" />
          </button>
        </li>
      </div>
    </nav>

    <section class="hero">
      <h2>Find Universities around Madrid</h2>
    </section>

    <main class="container-universities">
      <section class="container-cards-universities">
        <article class="inner-container-universities">
          <h1>Map Section</h1>
          <div>
            <label for="universitySelect" class="controls-card-label"
              >University
              <span>
                Choose the university you're looking for to see its location on
                the map.
              </span></label
            >
            <select id="universitySelect" size="4">
              <option>Loading universities...</option>
            </select>
          </div>
          <div>
            <label for="localitySelect" class="controls-card-label"
              >Neighborhood
              <span>
                Choose the neighborhood you want to filter by to discover the
                universities within.
              </span></label
            >
            <select id="localitySelect" size="4">
              <option>Loading locations...</option>
            </select>
          </div>

          <div>
            <label for="degreeSelect" class="controls-card-label"
              >Degree
              <span>
                Choose the degree you want to filter by to see universities that
                offer it.
              </span></label
            >
            <select id="degreeSelect" size="4">
              <option>Loading degrees...</option>
            </select>
          </div>
        </article>
        <a href="#" id="showUniversitiesBtn" class="btn">Show Universities</a>
      </section>
      <section class="results-card" id="resultsCard">
        <div id="resultsList" class="results-list"></div>
      </section>

      <section class="map-container-universities">
        <div id="map" class="map-universities"></div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-brand">
          <img src="../assets/svgs/logo.svg" alt="MotivSMA Logo" />
          <span>UniMove</span>
        </div>
        <div class="footer-links">
          <a href="#">About</a>
          <a href="#">Privacy Policy</a>
          <a href="#">Contact</a>
        </div>
        <div class="footer-copy">
          <p>
            &copy; 2025 UniMove | Built with â¤ï¸ for students around the world
          </p>
        </div>
      </div>
    </footer>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
      const map = L.map("map", { zoomControl: false }).setView(
        [40.4168, -3.7038],
        13
      );

      L.control
        .zoom({
          position: "topright",
        })
        .addTo(map);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      let universities = [];
      let universityMarkers = [];
      let degrees = [];
      let locations = [];

      const degreeSelect = document.getElementById("degreeSelect");
      const localitySelect = document.getElementById("localitySelect");
      const universitySelect = document.getElementById("universitySelect");
      const filterBtn = document.getElementById("showUniversitiesBtn");

      // Step 1: Define GitHub icons
      var redIcon = new L.Icon({
        iconUrl: "../assets/images/marker-icon-2x-red.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
      });

      async function fetchUniversities() {
        try {
          const res = await fetch("http://127.0.0.1:8080/api/get_universities");
          universities = await res.json();

          universitySelect.innerHTML = "";

          universities.forEach((u) => {
            const option = document.createElement("option");
            option.value = u.id;
            option.textContent = u.name;
            universitySelect.appendChild(option);
          });
          renderUniversities(universities);
        } catch (err) {
          console.error("Error fetching universities:", err);
        }
      }
      function renderUniversities(list) {
        if (universityMarkers) {
          universityMarkers.forEach((marker) => map.removeLayer(marker));
        }

        list.forEach((u) => {
          const marker = L.marker(
            [parseFloat(u.latitude), parseFloat(u.longitude)],
            { icon: redIcon }
          )
            .addTo(map)
            .bindPopup(`<b>${u.name}</b>`);
          universityMarkers.push(marker);
        });
        const allCoords = list.map((u) => [
          parseFloat(u.latitude),
          parseFloat(u.longitude),
        ]);
        if (allCoords.length > 0)
          map.fitBounds(allCoords, { padding: [50, 50] });
      }

      async function fetchDegrees() {
        try {
          const res = await fetch("http://127.0.0.1:8080/api/get_degrees");
          degrees = await res.json();

          degreeSelect.innerHTML = "";

          degrees.forEach((d) => {
            const option = document.createElement("option");
            option.value = d.id;
            option.textContent = d.name;
            degreeSelect.appendChild(option);
          });
        } catch (err) {
          console.error("Error fetching degrees:", err);
        }
      }
      async function fetchLocations() {
        try {
          const res = await fetch("http://127.0.0.1:8080/api/get_locations");
          locations = await res.json();

          localitySelect.innerHTML = "";

          locations.forEach((l) => {
            const option = document.createElement("option");
            option.value = l.id;
            option.textContent = l.name;
            localitySelect.appendChild(option);
          });
          console.log("Fetched locations:", locations);
        } catch (err) {
          console.error("Error fetching locations:", err);
        }
      }

      filterBtn.addEventListener("click", async () => {
        const selectedUniId = universitySelect.value;
        const selectedDegree = degreeSelect.value;
        const selectedLocation = localitySelect.value;

        // Caso 1: usuario eligiÃ³ una universidad
        if (selectedUniId && selectedUniId !== "Loading universities...") {
          console.log("Filtering by university:", selectedUniId);
          try {
            const uni = universities.find((u) => u.id == selectedUniId);

            if (universityMarkers) {
              universityMarkers.forEach((marker) => map.removeLayer(marker));
              universityMarkers = [];
            }

            const marker = L.marker(
              [parseFloat(uni.latitude), parseFloat(uni.longitude)],
              { icon: redIcon }
            )
              .addTo(map)
              .bindPopup(`<b>${uni.name}</b>`);

            universityMarkers.push(marker);
            map.setView(
              [parseFloat(uni.latitude), parseFloat(uni.longitude)],
              15
            );
          } catch (err) {
            console.error("Error filtering by university:", err);
          }
        }

        // Caso 2: usuario eligiÃ³ un degree
        else if (selectedDegree && selectedDegree !== "Loading degrees...") {
          const resultsList = document.getElementById("resultsList");
          console.log("Filtering by degree:", selectedDegree);
          try {
            if (universityMarkers) {
              universityMarkers.forEach((marker) => map.removeLayer(marker));
              universityMarkers = [];
            }
            if (resultsList) {
              resultsList.innerHTML = "";
            }

            // PeticiÃ³n al backend
            const res = await fetch(
              `http://127.0.0.1:8080/api/get_universities_by_degree/${selectedDegree}`
            );
            const filteredUnis = await res.json();

            if (!filteredUnis || filteredUnis.length === 0) {
              alert("No universities found for the selected degree.");
              return;
            }

            filteredUnis.forEach((uni) => {
              const marker = L.marker(
                [parseFloat(uni.latitude), parseFloat(uni.longitude)],
                { icon: redIcon }
              )
                .addTo(map)
                .bindPopup(`<b>${uni.name}</b><br>${selectedDegree}`);
              universityMarkers.push(marker);

              const card = document.createElement("div");
              card.classList.add("university-card");
              card.classList.add("uni-card");
              card.innerHTML = `
          <h3 style="color:#5a7c99; margin-bottom:12px; font-size:1.2rem;">
            ğŸ« ${uni.name}
          </h3>
          <p><strong>â­ Ranking:</strong> ${uni.ranking ?? "N/A"}</p>
          <p><strong>ğŸš‡ Public Transport:</strong> ${
            uni.publicTransport ?? "N/A"
          }</p>
          <p><strong>ğŸ“ Zip Code:</strong> ${uni.zipCode ?? "N/A"}</p>
          <p><strong>ğŸ“ Phone:</strong> ${uni.phoneNumber ?? "N/A"}</p>
        `;
              resultsList.appendChild(card);
              document.getElementById("resultsCard").style.display = "flex";
            });

            const firstUni = filteredUnis[0];
            map.setView(
              [parseFloat(firstUni.latitude), parseFloat(firstUni.longitude)],
              15
            );
          } catch (err) {
            console.error("Error filtering by degree:", err);
          }
        }

        // Caso 3: usuario eligiÃ³ un degree y una location
        else if (
          selectedDegree !== "Loading degrees..." &&
          selectedDegree &&
          selectedLocation !== "Loading locations..." &&
          selectedLocation
        ) {
          const resultsList = document.getElementById("resultsList");
          console.log(
            "Filtering by degree and location:",
            selectedDegree,
            selectedLocation
          );
          try {
            if (universityMarkers) {
              universityMarkers.forEach((marker) => map.removeLayer(marker));
              universityMarkers = [];
            }

            const res = await fetch(
              `http://127.0.0.1:8080/api/get_universities_by_degree_and_locality/${selectedDegree}${selectedLocation}`
            );
            const filteredUnis = await res.json();

            resultsList.innerHTML = "";

            if (!filteredUnis || filteredUnis.length === 0) {
              alert("No universities found for the selected degree.");
              return;
            }

            filteredUnis.forEach((uni) => {
              const marker = L.marker(
                [parseFloat(uni.latitude), parseFloat(uni.longitude)],
                { icon: redIcon }
              )
                .addTo(map)
                .bindPopup(`<b>${uni.name}</b><br>${selectedDegree}`);
              universityMarkers.push(marker);

              const card = document.createElement("div");
              card.classList.add("university-card");
              card.classList.add("uni-card");
              card.innerHTML = `
          <h3 style="color:#5a7c99; margin-bottom:12px; font-size:1.2rem;">
            ğŸ« ${uni.name}
          </h3>
          <p><strong>â­ Ranking:</strong> ${uni.ranking ?? "N/A"}</p>
          <p><strong>ğŸš‡ Public Transport:</strong> ${
            uni.publicTransport ?? "N/A"
          }</p>
          <p><strong>ğŸ“ Zip Code:</strong> ${uni.zipCode ?? "N/A"}</p>
          <p><strong>ğŸ“ Phone:</strong> ${uni.phoneNumber ?? "N/A"}</p>
        `;
              resultsList.appendChild(card);
              document.getElementById("resultsCard").style.display = "flex";
            });

            const firstUni = filteredUnis[0];
            map.setView(
              [parseFloat(firstUni.latitude), parseFloat(firstUni.longitude)],
              15
            );
          } catch (err) {
            console.error("Error showing all universities:", err);
          }
        }

        // Caso 4: usuario eligiÃ³ una location
        else if (
          selectedLocation &&
          selectedLocation !== "Loading locations..."
        ) {
          const resultsList = document.getElementById("resultsList");
          console.log("Filtering by location:", selectedLocation);
          try {
            if (universityMarkers) {
              universityMarkers.forEach((marker) => map.removeLayer(marker));
              universityMarkers = [];
            }

            const res = await fetch(
              `http://127.0.0.1:8080/api/get_universities_by_locality/${selectedLocation}`
            );
            const filteredUnis = await res.json();

            resultsList.innerHTML = "";

            if (!filteredUnis || filteredUnis.length === 0) {
              alert("No universities found for the selected degree.");
              return;
            }

            filteredUnis.forEach((uni) => {
              const marker = L.marker(
                [parseFloat(uni.latitude), parseFloat(uni.longitude)],
                { icon: redIcon }
              )
                .addTo(map)
                .bindPopup(`<b>${uni.name}</b><br>${selectedDegree}`);
              universityMarkers.push(marker);

              const card = document.createElement("div");
              card.classList.add("university-card");
              card.classList.add("uni-card");
              card.innerHTML = `
          <h3 style="color:#5a7c99; margin-bottom:12px; font-size:1.2rem;">
            ğŸ« ${uni.name}
          </h3>
          <p><strong>â­ Ranking:</strong> ${uni.ranking ?? "N/A"}</p>
          <p><strong>ğŸš‡ Public Transport:</strong> ${
            uni.publicTransport ?? "N/A"
          }</p>
          <p><strong>ğŸ“ Zip Code:</strong> ${uni.zipCode ?? "N/A"}</p>
          <p><strong>ğŸ“ Phone:</strong> ${uni.phoneNumber ?? "N/A"}</p>
        `;
              resultsList.appendChild(card);
              document.getElementById("resultsCard").style.display = "flex";
            });

            const firstUni = filteredUnis[0];
            map.setView(
              [parseFloat(firstUni.latitude), parseFloat(firstUni.longitude)],
              15
            );
          } catch (err) {
            console.error("Error filtering by location:", err);
          }
        } else {
          console.log("Showing all universities");
          window.alert(
            "Showing all universities, please select valid data to filter."
          );
          renderUniversities(universities);
          const resultsList = document.getElementById("resultsList");
          resultsList.innerHTML = "";
        }
        universitySelect.selectedIndex = "";
        localitySelect.selectedIndex = "";
        degreeSelect.selectedIndex = "";
      });

      fetchUniversities();
      fetchDegrees();
      fetchLocations();
    </script>

    <script>
      document.querySelectorAll(".controls-card-label").forEach((label) => {
        label.addEventListener("click", () => {
          const select = document.getElementById(label.getAttribute("for"));
          if (select.style.display === "block") {
            select.style.display = "none";
          } else {
            document
              .querySelectorAll(".container-cards-universities select")
              .forEach((s) => {
                s.style.display = "none";
              });
            select.style.display = "block";
            select.focus();
          }
        });
      });
    </script>
  </body>
</html>
