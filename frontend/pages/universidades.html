<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UniMove | Clinics Map</title>
    <link rel="stylesheet" href="../css/mapclinics.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  </head>
  <body>
    <nav>
      <div>
        <a href="../index.html">Moving</a>
        <a href="../index.html">Universities</a>
        <a href="../index.html">Internships</a>
      </div>
      <h1>UniMove</h1>
      <div>
        <a href="biomedical.html">Health</a>
        <a href="mapclinics.html">Clinical Maps</a>
        <a href="../index.html">Home</a>
      </div>
    </nav>

    <main class="container">
      <section class="hero">
        <h2>Find Universities around Madrid</h2>
        <p>Select a filter by name, locality or degrees.</p>
      </section>

      <section class="controls-card">
        <label for="universitySelect">University</label>
        <select id="universitySelect" size="5">
          <option>Loading universities...</option>
        </select>

        <label for="localitySelect">Locality</label>
        <select id="localitySelect" size="5">
      <option>Loading locations...</option>
        </select>

      <!-- Carreras -->
      <label for="degreeSelect">Degree</label>
      <select id="degreeSelect" size="5">
        <option>Loading degrees...</option>
      </select>

      <a href="#" id="showUniversitiesBtn" class="btn">Show Universities</a>
    </section>
    <section class="results-card" id="resultsCard">
         <div id="resultsList" class="results-list"></div>
    </section>

      <section class="map-container">
        <div id="map"></div>
      </section>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2024 UniMove. All rights reserved.</p>
      </div>
    </footer>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
      const map = L.map("map").setView([40.4168, -3.7038], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

 // Variables globales
    let universities = [];
    let universityMarkers = [];
    let degrees = [];
    let locations = [];

    const degreeSelect = document.getElementById("degreeSelect");
    const localitySelect = document.getElementById("localitySelect");
    const universitySelect = document.getElementById("universitySelect");
    const filterBtn = document.getElementById("showUniversitiesBtn");


// Step 1: Define GitHub icons
var redIcon = new L.Icon({
    iconUrl: '/assets/images/marker-icon-2x-red.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34]
});

async function fetchUniversities() {
      try {
        const res = await fetch("http://127.0.0.1:5000/get_universities");
        universities = await res.json();

         // Rellenar select de universidades
        universities.forEach(u => {
          const option = document.createElement("option");
          option.value =  u.id;
          option.textContent = u.name;
          universitySelect.appendChild(option);
          });
        renderUniversities(universities);
      } catch (err) {
        console.error("Error fetching universities:", err);
      }
    }
function renderUniversities(list) {
      // Limpiar marcadores previos
      if (universityMarkers) {
        universityMarkers.forEach(marker => map.removeLayer(marker));
      }
      // Dibujar cada universidad
      list.forEach(u => {
        const marker = L.marker([parseFloat(u.latitude), parseFloat(u.longitude)], { icon: redIcon })
          .addTo(map)
          .bindPopup(`<b>${u.name}</b>`);
        universityMarkers.push(marker);
      });
      const allCoords = list.map(u => [parseFloat(u.latitude), parseFloat(u.longitude)]);
      if (allCoords.length > 0) map.fitBounds(allCoords, { padding: [50, 50] });
    }

async function fetchDegrees() {
  try {
    const res = await fetch("http://127.0.0.1:5000/get_degrees");
    degrees = await res.json();
    
    degrees.forEach(d => {
      const option = document.createElement("option");
      option.value = d.id;
      option.textContent = d.name;
      degreeSelect.appendChild(option);
    });
  } catch (err) {
    console.error("Error fetching degrees:", err);
  }
}
;
async function fetchLocations() {
  try {
    const res = await fetch("http://127.0.0.1:5000/get_locations");
    locations = await res.json();
    locations.forEach(l => {
      const option = document.createElement("option");
      option.value = l.id;
      option.textContent = l.name;
      localitySelect.appendChild(option);
    });
    console.log("Fetched locations:", locations);
  } catch (err) {
    console.error("Error fetching locations:", err);
  }
}


filterBtn.addEventListener("click", async () => {
  const selectedUniId = universitySelect.value;
  const selectedDegree = degreeSelect.value;
  const selectedLocation = localitySelect.value;

  // Caso 1: usuario eligió una universidad
  if (selectedUniId && selectedUniId !== "Loading universities...") {
    console.log("Filtering by university:", selectedUniId);
    try {
      const uni = universities.find(u => u.id == selectedUniId);

      if (universityMarkers) {
        universityMarkers.forEach(marker => map.removeLayer(marker));
        universityMarkers = [];
      }

      const marker = L.marker(
        [parseFloat(uni.latitude), parseFloat(uni.longitude)],
        { icon: redIcon }
      )
        .addTo(map)
        .bindPopup(`<b>${uni.name}</b>`);

      universityMarkers.push(marker);
      map.setView([parseFloat(uni.latitude), parseFloat(uni.longitude)], 15);
    } catch (err) {
      console.error("Error filtering by university:", err);
    }
  }

  // Caso 2: usuario eligió un degree
  else if (selectedDegree && selectedDegree !== "Loading degrees...") {
     const resultsList = document.getElementById("resultsList");
    console.log("Filtering by degree:", selectedDegree);
    try {
      if (universityMarkers) {
        universityMarkers.forEach(marker => map.removeLayer(marker));
        universityMarkers = [];
      }
      if (resultsList) {
        resultsList.innerHTML = "";
      }

      // Petición al backend
      const res = await fetch(`http://127.0.0.1:5000/get_universities_by_degree/${selectedDegree}`);
      const filteredUnis = await res.json();

      if (!filteredUnis || filteredUnis.length === 0) {
        alert("No universities found for the selected degree.");
        return;
      }

      filteredUnis.forEach(uni => {
        // Añadir marcador
        const marker = L.marker(
          [parseFloat(uni.latitude), parseFloat(uni.longitude)],
          { icon: redIcon }
        )
          .addTo(map)
          .bindPopup(`<b>${uni.name}</b><br>${selectedDegree}`);
        universityMarkers.push(marker);

        // Crear tarjeta
        const card = document.createElement("div");
        card.classList.add("university-card");
        card.innerHTML = `
          <h3 style="color:#1a4d8f; margin-bottom:12px; font-size:1.2rem;">
            🏫 ${uni.name}
          </h3>
          <p><strong>⭐ Ranking:</strong> ${uni.ranking ?? "N/A"}</p>
          <p><strong>🚇 Public Transport:</strong> ${uni.publicTransport ?? "N/A"}</p>
          <p><strong>📍 Zip Code:</strong> ${uni.zipCode ?? "N/A"}</p>
          <p><strong>📞 Phone:</strong> ${uni.phoneNumber ?? "N/A"}</p>
        `;
        resultsList.appendChild(card);
      });

      const firstUni = filteredUnis[0];
      map.setView([parseFloat(firstUni.latitude), parseFloat(firstUni.longitude)], 15);
    } catch (err) {
      console.error("Error filtering by degree:", err);
    }
  }

  // Caso 3: usuario eligió un degree y una location
  else if ((selectedDegree!== "Loading degrees..." && selectedDegree) &&
           (selectedLocation !== "Loading locations..." && selectedLocation)) {
    const resultsList = document.getElementById("resultsList");
    console.log("Filtering by degree and location:", selectedDegree, selectedLocation);
   try {
      if (universityMarkers) {
        universityMarkers.forEach(marker => map.removeLayer(marker));
        universityMarkers = [];
      }

      // Petición al backend
      const res = await fetch(`http://127.0.0.1:5000/get_universities_by_degree_and_locality/${selectedDegree}${selectedLocation}`);
      const filteredUnis = await res.json();

      // Limpia lista anterior
      resultsList.innerHTML = "";

      if (!filteredUnis || filteredUnis.length === 0) {
        alert("No universities found for the selected degree.");
        return;
      }

      filteredUnis.forEach(uni => {
        // Añadir marcador
        const marker = L.marker(
          [parseFloat(uni.latitude), parseFloat(uni.longitude)],
          { icon: redIcon }
        )
          .addTo(map)
          .bindPopup(`<b>${uni.name}</b><br>${selectedDegree}`);
        universityMarkers.push(marker);

        // Crear tarjeta
        const card = document.createElement("div");
        card.classList.add("university-card");
        card.innerHTML = `
          <h3 style="color:#1a4d8f; margin-bottom:12px; font-size:1.2rem;">
            🏫 ${uni.name}
          </h3>
          <p><strong>⭐ Ranking:</strong> ${uni.ranking ?? "N/A"}</p>
          <p><strong>🚇 Public Transport:</strong> ${uni.publicTransport ?? "N/A"}</p>
          <p><strong>📍 Zip Code:</strong> ${uni.zipCode ?? "N/A"}</p>
          <p><strong>📞 Phone:</strong> ${uni.phoneNumber ?? "N/A"}</p>
        `;
        resultsList.appendChild(card);
      });

      const firstUni = filteredUnis[0];
      map.setView([parseFloat(firstUni.latitude), parseFloat(firstUni.longitude)], 15);
    } catch (err) {
      console.error("Error showing all universities:", err);
    }
    
  }
  // Caso 4: usuario eligió una location
  else if (selectedLocation && selectedLocation !== "Loading locations...") {
    const resultsList = document.getElementById("resultsList");
    console.log("Filtering by location:", selectedLocation);;
    try {
      if (universityMarkers) {
        universityMarkers.forEach(marker => map.removeLayer(marker));
        universityMarkers = [];
      }

      // Petición al backend
      const res = await fetch(`http://127.0.0.1:5000/get_universities_by_locality/${selectedLocation}`);
      const filteredUnis = await res.json();

      // Limpia lista anterior
      resultsList.innerHTML = "";

      if (!filteredUnis || filteredUnis.length === 0) {
        alert("No universities found for the selected degree.");
        return;
      }

      filteredUnis.forEach(uni => {
        // Añadir marcador
        const marker = L.marker(
          [parseFloat(uni.latitude), parseFloat(uni.longitude)],
          { icon: redIcon }
        )
          .addTo(map)
          .bindPopup(`<b>${uni.name}</b><br>${selectedDegree}`);
        universityMarkers.push(marker);

        // Crear tarjeta
        const card = document.createElement("div");
        card.classList.add("university-card");
        card.innerHTML = `
          <h3 style="color:#1a4d8f; margin-bottom:12px; font-size:1.2rem;">
            🏫 ${uni.name}
          </h3>
          <p><strong>⭐ Ranking:</strong> ${uni.ranking ?? "N/A"}</p>
          <p><strong>🚇 Public Transport:</strong> ${uni.publicTransport ?? "N/A"}</p>
          <p><strong>📍 Zip Code:</strong> ${uni.zipCode ?? "N/A"}</p>
          <p><strong>📞 Phone:</strong> ${uni.phoneNumber ?? "N/A"}</p>
        `;
        resultsList.appendChild(card);
      });

      const firstUni = filteredUnis[0];
      map.setView([parseFloat(firstUni.latitude), parseFloat(firstUni.longitude)], 15);
    } catch (err) {
      console.error("Error filtering by location:", err);
    }
  }
  else {
    // Mostrar todas las universidades
    console.log("Showing all universities");
    window.alert("Showing all universities,please select valid data to filter.");
    renderUniversities(universities);
    const resultsList = document.getElementById("resultsList");
    resultsList.innerHTML = "";
  }
  universitySelect.selectedIndex = "";
    localitySelect.selectedIndex = "";
    degreeSelect.selectedIndex = "";
});


// Llamar a la función

fetchUniversities();
fetchDegrees();
fetchLocations();
  </script>
  <script>
  if (!username) {
    window.location.href = "../index.html";
  }
  </script>
</body>
</html>
