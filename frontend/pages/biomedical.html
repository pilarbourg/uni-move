<script>
  async function fetchProfile() {
    const profileContainer = document.getElementById("profileContainer");
    const noProfile = document.getElementById("noProfile");
    const protocolSection = document.getElementById("protocolSection");
    const protocolContent = document.getElementById("protocolContent");

    const token = "fake-jwt-token"; // TESTING

    // Always load illnesses, even if user has no profile
    await loadIllnesses();

    if (!token) {
      profileContainer.style.display = "none";
      noProfile.style.display = "block";
      noProfile.innerHTML = `
        <p>Please log in to view or create your biomedical profile.</p>
        <a href="/login.html" class="btn">Log In</a>
      `;
      return;
    }

    try {
      const res = await fetch(
        "http://127.0.0.1:5000/api/get_biomedical_profile",
        {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      if (!res.ok) {
        // No profile found, show empty form with illnesses loaded
        profileContainer.style.display = "block";
        noProfile.style.display = "none";
        return;
      }

      const data = await res.json();
      console.log("Profile data:", data);

      if (data && Object.keys(data).length > 0 && !data.message) {
        noProfile.style.display = "none";
        profileContainer.style.display = "block";
        profileContainer.innerHTML = `
          <p><strong>Allergies:</strong> ${data.allergies || "None"}</p>
          <p><strong>Illnesses:</strong> ${(data.illnesses || [])
            .map((i) => i.name)
            .join(", ") || "None"}</p>
          <p><strong>Weight:</strong> ${data.weight || "N/A"} kg</p>
          <p><strong>Height:</strong> ${data.height_cm || "N/A"} cm</p>
        `;

        // Show illness protocols if available
        if (data.illnesses && data.illnesses.length > 0) {
          let html = "";

          data.illnesses.forEach((illness) => {
            html += `<h3 class="protocol-disease-name">${illness.name}</h3>`;

            const illnessProtocols = (data.protocols || []).filter(
              (p) => p.illness_id === illness.id
            );

            if (illnessProtocols.length > 0) {
              html += illnessProtocols
                .map(
                  (p) =>
                    `<p><strong>Step ${p.step_order}:</strong> ${p.instruction}</p>`
                )
                .join("");
            } else {
              html += "<p>No protocol available</p>";
            }
          });

          protocolContent.innerHTML = html;
          protocolSection.style.display = "block";
        } else {
          protocolSection.style.display = "none";
        }
      } else {
        // No profile yet
        profileContainer.style.display = "block";
        noProfile.style.display = "none";
      }
    } catch (err) {
      console.error("Fetch error:", err);
      profileContainer.style.display = "block";
      noProfile.style.display = "none";
    }
  }

  async function loadIllnesses() {
    try {
      const res = await fetch("http://127.0.0.1:5000/api/illnesses");
      if (!res.ok) throw new Error("Failed to fetch illnesses");
      const illnesses = await res.json();

      const select = document.getElementById("illnesses");
      if (!select) return;

      select.innerHTML = "";
      illnesses.forEach((ill) => {
        const option = document.createElement("option");
        option.value = ill.id;
        option.textContent = ill.name;
        select.appendChild(option);
      });

      console.log("Illnesses loaded:", illnesses);
    } catch (err) {
      console.error("Error loading illnesses:", err);
    }
  }

  fetchProfile();
</script>

<script>
  const form = document.getElementById("bioProfileForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const token = "fake-jwt-token"; // TESTING VALUE

    const profileData = {
      allergies: form.allergies.value,
      illnesses: Array.from(form.illnesses.selectedOptions).map(
        (opt) => opt.value
      ),
      weight: form.weight.value,
      height_cm: form.height_cm.value,
    };

    try {
      const res = await fetch(
        "http://127.0.0.1:5000/api/post_biomedical_profile",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(profileData),
        }
      );

      if (!res.ok) throw new Error("Failed to save profile");

      const data = await res.json();
      console.log("Profile saved:", data);

      fetchProfile();
    } catch (err) {
      console.error("Error submitting form:", err);
    }
  });
</script>

<script>
  const chatInput = document.getElementById("chatInput");
  const chatBtn = document.getElementById("chatBtn");
  const chatLog = document.getElementById("chatLog");
  const loading = document.getElementById("loading");
  const errorPopup = document.getElementById("errorPopup");

  async function sendChatMessage() {
    const prompt = chatInput.value.trim();
    if (!prompt) return;

    chatLog.innerHTML += `<p><strong>You:</strong> ${prompt}</p>`;
    chatInput.value = "";

    loading.style.display = "block";

    try {
      const res = await fetch("http://127.0.0.1:5000/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt }),
      });

      if (!res.ok) {
        throw new Error("Request failed");
      }

      const data = await res.json();

      chatLog.innerHTML += `<p><strong>Bot:</strong> ${data.response}</p>`;
      chatLog.scrollTop = chatLog.scrollHeight;
    } catch (err) {
      console.error("Chat error:", err);

      errorPopup.style.display = "block";
      setTimeout(() => {
        errorPopup.style.display = "none";
      }, 3000);
    } finally {
      loading.style.display = "none";
    }
  }

  chatBtn.addEventListener("click", sendChatMessage);
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendChatMessage();
  });
</script>
