<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UniMove Biomedical Portal</title>
    <link rel="stylesheet" href="../css/biomedical.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar">
      <h1 class="logo">
        <img
          src="../assets/svgs/logo.svg"
          style="width: 36px; height: 36px"
        />UniMove
      </h1>

      <ul class="menu">
        <li class="dropdown">
          <a href="#">Universities</a>
          <ul class="dropdown-content">
            <li><a href="universidades.html">Search on Map</a></li>
            <li><a href="searchByDegree.html">Search by Degree</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Moving</a>
          <ul class="dropdown-content">
            <li><a href="mapaapartamentos.html">Apartments</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Students</a>
          <ul class="dropdown-content">
            <li><a href="../index.html">Internships</a></li>
            <li><a href="studentLife.html">Study Section</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#">Health</a>
          <ul class="dropdown-content">
            <li><a href="biomedical.html">Health</a></li>
            <li><a href="mapclinics.html">Clinical Maps</a></li>
          </ul>
        </li>
      </ul>

      <div class="nav-right">
        <a href="../index.html">
          <img src="../assets/svgs/home.svg" class="home-button"
        /></a>

        <li class="user-section">
          <span id="user-name" style="font-weight: bold; color: #5a7c99"></span>
          <button id="logout" class="boton" style="display: none">
            <img src="../assets/svgs/logout.svg" />
          </button>
        </li>
      </div>
    </nav>

    <main>
      <section class="main-biomed-section">
        <article class="hero">
          <img
            src="../assets/svgs/health_cross_24dp_FFFFFF_FILL0_wght400_GRAD0_opsz24.svg"
            alt="Biomedical Illustration"
          />
          <h2>
            Keep Your Health Info<br />
            Safe and Accessible
          </h2>
          <p>
            Easily manage your allergies, illnesses, and health profile while
            moving between universities. Set up your biomedical profile to
            ensure quick access to vital health information whenever you need
            it. Focus on your studies and adventures, knowing your health data
            is just a click away.
          </p>
        </article>
        <div class="main-biomed">
          <section class="profile-card">
            <article class="profile-form">
              <h2>Biomedical Profile</h2>

              <div id="noProfile" style="display: none" class="empty-profile">
                <p>You haven‚Äôt set up your biomedical profile yet.</p>
                <a href="#" class="btn" id="getStartedBtn">Get Started</a>
              </div>

              <div id="profileContainer" style="display: none">
                <form id="bioProfileForm">
                  <div>
                    <label for="allergies">Allergies</label>
                    <input
                      type="text"
                      id="allergies"
                      name="allergies"
                      placeholder="Peanuts, Pollen..."
                    />

                    <label for="illnesses">Illnesses</label>
                    <select id="illnesses" name="illnesses" multiple></select>
                  </div>
                  <div>
                    <label for="weight">Weight (kg)</label>
                    <input
                      type="number"
                      id="weight"
                      name="weight"
                      step="0.1"
                      placeholder="72.5"
                    />

                    <label for="height_cm">Height (cm)</label>
                    <input
                      type="number"
                      id="height_cm"
                      name="height_cm"
                      step="0.1"
                      placeholder="175.0"
                    />
                    <button type="submit" class="btn">Save Profile</button>
                  </div>
                </form>
              </div>
            </article>
          </section>
          <section class="features-grid">
            <div class="feature">
              <h3>ü¶† Allergies & Conditions</h3>
              <p>
                Record and manage allergies or chronic illnesses for a smooth
                campus experience.
              </p>
            </div>
            <div class="feature">
              <h3>üìà Weight & Height Tracking</h3>
              <p>
                Monitor your health stats and keep them updated for wellness
                programs.
              </p>
            </div>
            <div class="feature">
              <h3>üéì Student Friendly</h3>
              <p>
                Easy-to-use interface designed specifically for busy students on
                the move.
              </p>
            </div>
          </section>
        </div>
      </section>

      <section id="contactsSection" class="contacts-section">
        <h2>Medical Contacts</h2>
        <p>Add your medical contacts to share any medical conditions!</p>

        <button id="addContactBtn" class="btn">+ Add Contact</button>

        <form id="contactForm" style="display: none; margin-top: 1rem">
          <input type="hidden" id="contactId" />

          <label for="contactName">Name</label>
          <input
            type="text"
            id="contactName"
            name="name"
            placeholder="Full Name"
            required
          />
          <div id="errorName" class="error-message">
            Please enter first and last name (letters only).
          </div>

          <label for="contactPhone">Phone</label>
          <input
            type="tel"
            id="contactPhone"
            name="phone"
            placeholder="+1 234 567 890"
          />
          <div id="errorPhone" class="error-message">
            Must start with +country code and contain 9 digits (e.g.
            +34600123456)
          </div>

          <label for="contactEmail">Email</label>
          <input
            type="email"
            id="contactEmail"
            name="email"
            placeholder="example@email.com"
          />
          <div id="errorEmail" class="error-message">
            Please enter a valid email (example@email.com)
          </div>

          <div style="display: flex; gap: 10px; margin-top: 10px">
            <button type="submit" class="btn">Save Contact</button>
            <button type="button" id="cancelContactBtn" class="btn">
              Cancel
            </button>
          </div>
        </form>

        <div id="contactsList" class="contacts-list" style="margin-top: 1rem">
          <p class="no-contacts">Loading contacts...</p>
        </div>

        <div id="reminder-section" class="p-3 mt-2 border rounded">
          <h5>Send medical reminders</h5>
          <p>Select the contact(s) and write your reminder.</p>

          <div id="contact-list-reminders" class="mb-2"></div>

          <textarea
            id="reminder-message"
            class="form-control mb-2"
            placeholder="Example: I'm allergic to peanuts"
          ></textarea>

          <button id="send-reminder-btn" class="btn btn-primary">
            Send reminder
          </button>
        </div>
      </section>

      <section class="sub-biomed-section">
        <section id="protocolSection" class="protocol-section">
          <div class="protocol-container">
            <h2 class="protocol-heading">Illness Protocols</h2>
            <p>
              Quickly access step-by-step protocols for managing your illnesses
              during emergencies or routine care so you‚Äôre always prepared, no
              matter where you are.
            </p>
            <div id="protocolContent" class="protocol-box">
              <i>Create your biomedical profile to see protocols here.</i>
            </div>
          </div>
        </section>

        <section class="chatbot-section">
          <article class="biomedical-chatbot-article">
            <h1>Biomedical Chatbot</h1>
            <p>
              Need quick health advice? Our AI-powered biomedical chatbot is
              here to help! Whether you have questions about symptoms,
              medications, or general health tips, just type your query and get
              instant responses.
            </p>

            <div id="chatLog"></div>

            <div
              id="loading"
              style="
                display: none;
                margin: 10px 0;
                font-style: italic;
                color: gray;
              "
            >
              ‚è≥ Thinking...
            </div>

            <div
              id="errorPopup"
              style="
                display: none;
                position: fixed;
                top: 20px;
                right: 20px;
                background: red;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
              "
            >
              Error: Could not connect to chatbot.
            </div>

            <div class="chatbot-input-div">
              <input
                id="chatInput"
                type="text"
                placeholder="Ask anything about health..."
              />
              <button id="chatBtn" class="btn">Chat Now</button>
            </div>
          </article>
        </section>
      </section>
    </main>

    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-brand">
          <img src="../assets/svgs/logo.svg" alt="MotivSMA Logo" />
          <span>UniMove</span>
        </div>
        <div class="footer-links">
          <a href="#">About</a>
          <a href="#">Privacy Policy</a>
          <a href="#">Contact</a>
        </div>
        <div class="footer-copy">
          <p>
            &copy; 2025 UniMove | Built with ‚ù§Ô∏è for students around the world
          </p>
        </div>
      </div>
    </footer>

    <script>
      async function fetchProfile() {
        const profileContainer = document.getElementById("profileContainer");
        const noProfile = document.getElementById("noProfile");
        const protocolSection = document.getElementById("protocolSection");
        const protocolContent = document.getElementById("protocolContent");

        const token = "fake-jwt-token"; // Replace with real token in production

        if (!token) {
          profileContainer.style.display = "none";
          noProfile.style.display = "block";
          noProfile.innerHTML = `
          <p>Please log in to view or create your biomedical profile.</p>
          <a href="/login.html" class="btn">Log In</a>
        `;
          return;
        }

        try {
          const res = await fetch(
            "http://127.0.0.1:8080/api/get_biomedical_profile",
            {
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (res.status === 404) {
            profileContainer.style.display = "block";
            noProfile.style.display = "none";
            await loadIllnesses();
            return;
          }

          if (!res.ok) throw new Error("Failed to fetch profile");

          const data = await res.json();

          if (data && Object.keys(data).length > 0 && !data.message) {
            noProfile.style.display = "none";
            profileContainer.style.display = "block";
            profileContainer.innerHTML = `
            <p><strong>Allergies:</strong> ${data.allergies || "None"}</p>
            <p><strong>Illnesses:</strong> ${
              (data.illnesses || []).map((i) => i.name).join(", ") || "None"
            }</p>
            <p><strong>Weight:</strong> ${data.weight || "N/A"} kg</p>
            <p><strong>Height:</strong> ${data.height_cm || "N/A"} cm</p>
          `;

            if (data.illnesses && data.illnesses.length > 0) {
              protocolContent.innerHTML = "";
              data.illnesses.forEach((illness) => {
                const illnessDiv = document.createElement("div");
                illnessDiv.classList.add("individual-protocol");

                const illnessTitle = document.createElement("h3");
                illnessTitle.classList.add("protocol-disease-name");
                illnessTitle.textContent = illness.name;
                illnessDiv.appendChild(illnessTitle);

                const illnessProtocols = (data.protocols || []).filter(
                  (p) => p.illness_id === illness.id
                );

                if (illnessProtocols.length > 0) {
                  illnessProtocols.forEach((p) => {
                    const step = document.createElement("p");
                    step.innerHTML = `<strong>Step ${p.step_order}:</strong> ${p.instruction}`;
                    illnessDiv.appendChild(step);
                  });
                } else {
                  const noStep = document.createElement("p");
                  noStep.textContent = "No protocol available.";
                  illnessDiv.appendChild(noStep);
                }

                protocolContent.appendChild(illnessDiv);
              });
              protocolSection.style.display = "block";
            } else {
              protocolSection.style.display = "none";
            }
          } else {
            profileContainer.style.display = "block";
            noProfile.style.display = "none";
            await loadIllnesses();
          }
        } catch (err) {
          console.error("Fetch error:", err);
          profileContainer.style.display = "block";
          noProfile.style.display = "none";
          await loadIllnesses();
        }
      }

      async function loadIllnesses() {
        try {
          const res = await fetch("http://127.0.0.1:8080/api/illnesses");
          if (!res.ok) throw new Error("Failed to fetch illnesses");
          const illnesses = await res.json();

          const select = document.getElementById("illnesses");
          if (!select) return;

          select.innerHTML = "";
          illnesses.forEach((ill) => {
            const option = document.createElement("option");
            option.value = ill.id;
            option.textContent = ill.name;
            select.appendChild(option);
          });

          console.log("Illnesses loaded:", illnesses);
        } catch (err) {
          console.error("Error loading illnesses:", err);
        }
      }

      fetchProfile();
    </script>

    <script>
      const form = document.getElementById("bioProfileForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const token = "fake-jwt-token"; // TESTING VALUE

        const profileData = {
          allergies: form.allergies.value,
          illnesses: Array.from(form.illnesses.selectedOptions).map(
            (opt) => opt.value
          ),
          weight: form.weight.value,
          height_cm: form.height_cm.value,
        };

        try {
          const res = await fetch(
            "http://127.0.0.1:8080/api/post_biomedical_profile",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(profileData),
            }
          );

          if (!res.ok) throw new Error("Failed to save profile");

          const data = await res.json();
          console.log("Profile saved:", data);

          fetchProfile();
        } catch (err) {
          console.error("Error submitting form:", err);
        }
      });
    </script>

    <script>
      const chatInput = document.getElementById("chatInput");
      const chatBtn = document.getElementById("chatBtn");
      const chatLog = document.getElementById("chatLog");
      const loading = document.getElementById("loading");
      const errorPopup = document.getElementById("errorPopup");

      async function sendChatMessage() {
        const prompt = chatInput.value.trim();
        if (!prompt) return;

        chatLog.innerHTML += `<p><strong>You:</strong> ${prompt}</p>`;
        chatInput.value = "";

        loading.style.display = "block";

        try {
          const res = await fetch("http://127.0.0.1:8080/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
          });

          if (!res.ok) {
            throw new Error("Request failed");
          }

          const data = await res.json();

          chatLog.innerHTML += `<p><strong>Bot:</strong> ${data.response}</p>`;
          chatLog.scrollTop = chatLog.scrollHeight;
        } catch (err) {
          console.error("Chat error:", err);

          errorPopup.style.display = "block";
          setTimeout(() => {
            errorPopup.style.display = "none";
          }, 3000);
        } finally {
          loading.style.display = "none";
        }
      }

      chatBtn.addEventListener("click", sendChatMessage);
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendChatMessage();
      });
    </script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      $(document).ready(function () {
        const token = "fake-jwt-token";

        const $contactForm = $("#contactForm");
        const $addBtn = $("#addContactBtn");
        const $cancelBtn = $("#cancelContactBtn");
        const $contactsList = $("#contactsList");

        const $name = $("#contactName");
        const $phone = $("#contactPhone");
        const $email = $("#contactEmail");
        const $id = $("#contactId");

        function showError($element, message) {
          $element.fadeIn(200).text(message);
        }

        function hideError($element) {
          $element.fadeOut(150).text("");
        }

        function validateName() {
          const value = $name.val().trim();
          const regex =
            /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±'-]+(\s+[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±'-]+)+$/;
          if (!regex.test(value)) {
            showError($("#errorName"), "Please enter your first and last name");
            $name.addClass("invalid");
            return false;
          }
          hideError($("#errorName"));
          $name.removeClass("invalid");
          return true;
        }

        function validatePhone() {
          const value = $phone.val().trim();
          const regex = /^\+\d{1,3}\s\d{9}$/;
          if (!regex.test(value)) {
            showError(
              $("#errorPhone"),
              "Phone must start with +country code and then 9 digits"
            );
            $phone.addClass("invalid");
            return false;
          }
          hideError($("#errorPhone"));
          $phone.removeClass("invalid");
          return true;
        }

        function validateEmail() {
          const value = $email.val().trim();
          const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!regex.test(value)) {
            showError($("#errorEmail"), "Please enter a valid email address");
            $email.addClass("invalid");
            return false;
          }
          hideError($("#errorEmail"));
          $email.removeClass("invalid");
          return true;
        }

        $name.on("input", validateName);
        $phone.on("input", validatePhone);
        $email.on("input", validateEmail);

        function resetForm() {
          $contactForm[0].reset();
          hideError($("#errorName"));
          hideError($("#errorPhone"));
          hideError($("#errorEmail"));
          $name.removeClass("invalid");
          $phone.removeClass("invalid");
          $email.removeClass("invalid");
        }

        async function loadContacts() {
          try {
            const res = await fetch(
              "http://127.0.0.1:8080/api/medical_contacts",
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            const contacts = await res.json();

            if (!contacts.length) {
              $contactsList.html("<p>No contacts yet</p>");
              return;
            }

            $contactsList.html(
              contacts
                .map(
                  (c) => `
              <div class="contact-item" style="margin-bottom: 1rem;">
                <p><strong>${c.name}</strong><br>üìû ${c.phone}<br>‚úâÔ∏è ${
                    c.email || "N/A"
                  }</p>
                <div class="contact-actions">
                  <button class="btn editBtn" data-id="${c.id}" data-name="${
                    c.name
                  }" data-phone="${c.phone}" data-email="${
                    c.email || ""
                  }">‚úèÔ∏è Edit</button>
                  <button class="btn deleteBtn" data-id="${
                    c.id
                  }">üóëÔ∏è Delete</button>
                </div>
              </div>`
                )
                .join("")
            );

            $(".deleteBtn").on("click", async function () {
              const id = $(this).data("id");
              if (confirm("Are you sure you want to delete this contact?")) {
                await fetch(
                  `http://127.0.0.1:8080/api/medical_contacts/${id}`,
                  {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${token}` },
                  }
                );
                loadContacts();
              }
            });

            $(".editBtn").on("click", function () {
              const contact = $(this).data();
              $id.val(contact.id);
              $name.val(contact.name);
              $phone.val(contact.phone);
              $email.val(contact.email);
              $contactForm.fadeIn(300);
              $addBtn.hide();
            });
          } catch (err) {
            console.error(err);
            $contactsList.html("<p>Error loading contacts ‚ö†Ô∏è</p>");
          }
        }

        function loadContactsForReminders(contacts) {
          const container = $("#contact-list-reminders");
          container.empty();

          contacts.forEach((c) => {
            const checkbox = $(`
            <div>
              <label>
                <input type="checkbox" value="${c.id}"> ${c.name}
              </label>
            </div>
          `);
            container.append(checkbox);
          });
        }

        async function refreshRemindersList() {
          try {
            const res = await fetch(
              "http://127.0.0.1:8080/api/medical_contacts",
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            const contacts = await res.json();
            loadContactsForReminders(contacts);
          } catch (err) {
            console.error("Error loading reminder contacts:", err);
          }
        }

        refreshRemindersList();

        $("#send-reminder-btn").on("click", async () => {
          const message = $("#reminder-message").val().trim();
          const contact_ids = $("#contact-list-reminders input:checked")
            .map((_, el) => parseInt(el.value))
            .get();

          if (!message || contact_ids.length === 0) {
            showToast(
              "Select at least a contact and write the reminder.",
              "info"
            );
            return;
          }

          try {
            const biomedical_profile_id = window.currentProfileId || 1; // replace with real profile ID

            const res = await fetch(
              "http://127.0.0.1:8080/api/post_medical_reminder",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  biomedical_profile_id,
                  contact_ids,
                  message,
                }),
              }
            );

            const result = await res.json();

            if (res.ok) {
              showToast("Medical reminder sent successfully!", "success");
              $("#reminder-message").val("");
              $("#contact-list-reminders input:checked").prop("checked", false);
            } else {
              showToast(
                "Error sending the reminder. Please try again.",
                "error"
              );
            }
          } catch (err) {
            console.error(err);
            showToast("Couldn't connect to the server.", "error");
          }
        });

        function showToast(message) {
          const container = document.getElementById("toast-container");
          const toast = document.createElement("div");
          toast.className = "toast";
          toast.textContent = message;
          container.appendChild(toast);

          setTimeout(() => {
            toast.remove();
          }, 4000);
        }

        $addBtn.on("click", function () {
          resetForm();
          $id.val("");
          $addBtn.hide();
          $contactForm.fadeIn(300);
        });

        $cancelBtn.on("click", function () {
          resetForm();
          $contactForm.fadeOut(300, function () {
            $addBtn.fadeIn(200);
          });
        });

        $contactForm.on("submit", async function (e) {
          e.preventDefault();

          const validName = validateName();
          const validPhone = validatePhone();
          const validEmail = validateEmail();

          if (!validName || !validPhone || !validEmail) return;

          const contactData = {
            name: $name.val().trim(),
            phone: $phone.val().trim(),
            email: $email.val().trim(),
          };

          const id = $id.val();
          const method = id ? "PUT" : "POST";
          const url = id
            ? `http://127.0.0.1:8080/api/medical_contacts/${id}`
            : "http://127.0.0.1:8080/api/medical_contacts";

          try {
            const res = await fetch(url, {
              method,
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(contactData),
            });

            if (!res.ok) throw new Error("Failed to save contact");

            resetForm();
            $contactForm.fadeOut(300, function () {
              $addBtn.fadeIn(200);
              loadContacts();
            });
          } catch (err) {
            console.error("Error saving contact:", err);
            showToast(
              "Something went wrong while saving this contact",
              "error"
            );
          }
        });

        loadContacts();
      });
    </script>

    <script>
      function showPopup(message, type = "error") {
        const popup = document.createElement("div");
        popup.classList.add("popup-message", type);
        popup.textContent = message;
        document.body.appendChild(popup);

        setTimeout(() => popup.remove(), 2500);
      }
    </script>
    <div id="toast-container"></div>
  </body>
</html>
