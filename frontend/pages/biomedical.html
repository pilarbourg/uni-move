<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UniMove Biomedical Portal</title>
    <link rel="stylesheet" href="../css/biomedical.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav>
      <div>
        <a href="../index.html">Moving</a>
        <a href="../index.html">Universities</a>
        <a href="../index.html">Internships</a>
      </div>
      <h1>UniMove</h1>
      <div>
        <a href="biomedical.html">Health</a>
        <a href="mapclinics.html">Clinical Maps</a>
        <a href="../index.html">Home</a>
      </div>
    </nav>

    <main>
      <section class="main-biomed-section">
        <article class="hero">
          <img
            src="../assets/svgs/health_cross_24dp_FFFFFF_FILL0_wght400_GRAD0_opsz24.svg"
            alt="Biomedical Illustration"
          />
          <h2>
            Keep Your Health Info<br />
            Safe and Accessible
          </h2>
          <p>
            Easily manage your allergies, illnesses, and health profile while
            moving between universities. Set up your biomedical profile to
            ensure quick access to vital health information whenever you need
            it. Focus on your studies and adventures, knowing your health data
            is just a click away.
          </p>
        </article>
        <section class="profile-card">
          <article class="profile-form">
            <h2>Biomedical Profile</h2>

            <div id="noProfile" style="display: none" class="empty-profile">
              <p>You haven’t set up your biomedical profile yet.</p>
              <a href="#" class="btn" id="getStartedBtn">Get Started</a>
            </div>

            <div id="profileContainer" style="display: none">
              <form id="bioProfileForm">
                <label for="allergies">Allergies</label>
                <input
                  type="text"
                  id="allergies"
                  name="allergies"
                  placeholder="Peanuts, Pollen..."
                />

                <label for="illnesses">Illnesses</label>
                <input
                  type="text"
                  id="illnesses"
                  name="illnesses"
                  placeholder="Asthma, Diabetes..."
                />

                <label for="weight">Weight (kg)</label>
                <input
                  type="number"
                  id="weight"
                  name="weight"
                  step="0.1"
                  placeholder="72.5"
                />

                <label for="height_cm">Height (cm)</label>
                <input
                  type="number"
                  id="height_cm"
                  name="height_cm"
                  step="0.1"
                  placeholder="175.0"
                />

                <button type="submit" class="btn">Save Profile</button>
              </form>
            </div>
          </article>
        </section>
      </section>

      <section class="features-grid">
        <div class="feature">
          <h3>Allergies & Conditions</h3>
          <p>
            Record and manage allergies or chronic illnesses for a smooth campus
            experience.
          </p>
        </div>
        <div class="feature">
          <h3>Weight & Height Tracking</h3>
          <p>
            Monitor your health stats and keep them updated for wellness
            programs.
          </p>
        </div>
        <div class="feature">
          <h3>Student Friendly</h3>
          <p>
            Easy-to-use interface designed specifically for busy students on the
            move.
          </p>
        </div>
      </section>
    </main>

    <footer>
      <p>&copy; 2025 UniMove | Built with ❤️ for students around the world</p>
    </footer>

    <script>
      async function fetchProfile() {
        const profileContainer = document.getElementById("profileContainer");
        const noProfile = document.getElementById("noProfile");

        //const token = localStorage.getItem("token") || "";
        const token = "fake-jwt-token"; // Simulate logged-in user

        if (!token) {
          // Case 1: Not logged in
          profileContainer.style.display = "none";
          noProfile.style.display = "block";
          noProfile.innerHTML = `
            <p>Please log in to view or create your biomedical profile.</p>
            <a href="/login.html" class="btn">Log In</a>
          `;
          return;
        }

        try {
          const res = await fetch(
            "http://127.0.0.1:5000/api/get_biomedical_profile",
            {
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!res.ok) {
            // Case 2: Logged in, no profile exists
            profileContainer.style.display = "block";
            noProfile.style.display = "none";
            return;
          }

          const data = await res.json();

          if (data && Object.keys(data).length > 0 && !data.message) {
            // Case 3: Profile exists, show read-only
            noProfile.style.display = "none";
            profileContainer.style.display = "block";
            profileContainer.innerHTML = `
              <p><strong>Allergies:</strong> ${data.allergies || "None"}</p>
              <p><strong>Illnesses:</strong> ${data.illnesses || "None"}</p>
              <p><strong>Weight:</strong> ${data.weight || "N/A"} kg</p>
              <p><strong>Height:</strong> ${data.height_cm || "N/A"} cm</p>
            `;
          } else {
            // Logged in but empty profile
            profileContainer.style.display = "block";
            noProfile.style.display = "none";
          }
        } catch (err) {
          console.error("Fetch error:", err);
          profileContainer.style.display = "block";
          noProfile.style.display = "none";
        }
      }

      fetchProfile();
    </script>

    <script>
      const form = document.getElementById("bioProfileForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault(); // prevent page reload

        const token = "fake-jwt-token"; // later: real JWT from user session

        // Gather form values
        const profileData = {
          allergies: form.allergies.value,
          illnesses: form.illnesses.value,
          weight: form.weight.value,
          height_cm: form.height_cm.value,
        };

        try {
          const res = await fetch(
            "http://127.0.0.1:5000/api/post_biomedical_profile",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(profileData),
            }
          );

          if (!res.ok) throw new Error("Failed to save profile");

          const data = await res.json();
          console.log("Profile saved:", data);

          // Optionally, refresh the profile display
          fetchProfile();
        } catch (err) {
          console.error("Error submitting form:", err);
        }
      });
    </script>
  </body>
</html>
