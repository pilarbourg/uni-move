<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Details</title>
  <link rel="stylesheet" href="../css/company.css" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
   
</head>

<body>

  <div class="overlay">

    <!-- â­ BOTÃ“N + TÃTULO -->
    <div class="button-title-container">
      <button class="back-btn" onclick="history.back()">â† Back</button>
      <h1 class="company-title" id="companyName">Loading...</h1>
    </div>

    <!-- â­ CONTENEDOR PRINCIPAL -->
    <div class="company-wrapper">
      <div class="company-main-card">

        <!-- â­ BLOQUE 1: DETAILS + PRICING + GALLERY -->
        <div class="details-split">

          <!-- LEFT COLUMN -->
          <div class="left-column">

            <div class="details-grid">

              <!-- â­ COMPANY DETAILS MINI CARD -->
              <div class="mini-card">
                <h3 class="mini-title">Company Details</h3>

                <div class="details-center">
                  <div class="detail-row"><span>ğŸ“„</span> <strong>CIF:</strong> <span id="companyCIF"></span></div>
                  <div class="detail-row"><span>ğŸ’¶</span> <strong>Base fee:</strong> <span id="companyBaseFee"></span></div>
                  <div class="detail-row"><span>ğŸ“</span> <strong>City:</strong> <span id="companyCity"></span></div>
                  <div class="detail-row"><span>â³</span> <strong>Estimated:</strong> <span id="companyTime"></span></div>
                  <div class="detail-row"><span>ğŸ‹ï¸</span> <strong>Max weight:</strong> <span id="companyWeight"></span></div>
                  <div class="detail-row"><span>â­</span> <strong>Rating:</strong> <span id="companyRatingStars"></span> <span id="companyRating"></span></div>
                </div>
              </div>

              <!-- â­ PRICING MINI CARD -->
              <div class="mini-card">
                <h3 class="mini-title">Pricing</h3>

                <div class="details-center">
                  <div class="detail-row"><span>ğŸ“¦</span> <strong>Small package:</strong> <span id="priceSmall"></span></div>
                  <div class="detail-row"><span>ğŸ“¦</span> <strong>Medium package:</strong> <span id="priceMedium"></span></div>
                  <div class="detail-row"><span>ğŸ“¦</span> <strong>Large package:</strong> <span id="priceLarge"></span></div>
                  <div class="detail-row"><span>ğŸšš</span> <strong>Solo traslado:</strong> <span id="priceSolo"></span></div>
                  <div class="detail-row"><span>ğŸ“¤</span> <strong>Mudanza:</strong> <span id="priceMudanza"></span></div>
                  <div class="detail-row"><span>ğŸ </span> <strong>Mudanza completa:</strong> <span id="priceMudanzaCompleta"></span></div>
                </div>
              </div>

            </div> <!-- end details-grid -->
          </div> <!-- end left column -->

          <!-- RIGHT COLUMN: GALLERY -->
          <div class="right-column">
            <h3 class="gallery-tittle">Image Gallery</h3>
            <div class="gallery" id="companyImages"></div>
          </div>

        </div> <!-- end details-split -->


        <!-- â­ BLOQUE 2: ESTIMATED COST -->
        <div class="estimate-card">
          <h2 class="estimate-title">Estimated Move Cost</h2>

         <div class="estimate-row">
          <h5 class="estimate-label">ğŸ”œ Origin â†’ Destination:</h5>
          <span id="estimateRoute">Loading...</span>
          </div>

          <div class="estimate-row">
          <h5 class="estimate-label">â†”ï¸ Total distance:</h5>
          <span id="estimateDistance">- km</span>
          </div>

          <div class="estimate-row">
          <h5 class="estimate-label">ğŸ“¥ Selected packages:</h5>
          <span id="estimatePackages">-</span>
         </div>

          <div class="package-breakdown-card">
          <h5 class="pb-title">Package Details</h5>
          <div id="packageBreakdownList"></div>
         </div>

         <div class="estimate-row">
          <h5 class="estimate-label">ğŸ‘£ Move type:</h5>
          <span id="estimateType">-</span>
         </div>

      </div>


        <!-- â­ BLOQUE 3: REVIEWS -->
        <h3 class="subsection">Reviews</h3>
        <div class="reviews-section" id="reviewsList"></div>


        <!-- â­ BLOQUE 4: CONTACT -->
        <h3 class="subsection">Contact</h3>
        <div class="contact-section">
          <div class="contact-info">
            <p><strong>Phone:</strong> <span id="companyPhone"></span></p>
            <p><strong>Email:</strong> <span id="companyEmail"></span></p>
          </div>

          <textarea class="contact-message" id="contactMessage" placeholder="Write your message..."></textarea>

          <button class="contact-send-btn" onclick="sendMessage()">Send Message</button>
        </div>

      </div> <!-- end main-card -->
    </div> <!-- end wrapper -->

  </div> <!-- end overlay -->


</body>

  <script>
  /* -------------------------------------------------------
   â­  GET URL PARAMS
------------------------------------------------------- */
function getParams() {
  const params = new URLSearchParams(window.location.search);

  return {
    id: params.get("id"),
    from: params.get("from"),
    to: params.get("to"),
    date: params.get("date"),
    small: Number(params.get("small")),
    medium: Number(params.get("medium")),
    large: Number(params.get("large")),
    type: params.get("type")
  };
}

/* -------------------------------------------------------
   â­  RENDER STARS
------------------------------------------------------- */
function renderStars(n) {
  let stars = "";
  const full = Math.floor(n);
  const half = n % 1 >= 0.5;

  for (let i = 0; i < full; i++) stars += "â˜…";
  if (half) stars += "â˜†";

  return stars;
}

/* -------------------------------------------------------
   â­  RENDER PACKAGE BREAKDOWN
------------------------------------------------------- */
function renderPackageBreakdown(packages) {
  const container = document.getElementById("packageBreakdownList");
  container.innerHTML = "";

  const descriptions = {
    small: "up to 25 kg",
    medium: "25â€“50 kg",
    large: "over 50 kg"
  };

  Object.entries(packages).forEach(([type, count]) => {
    if (count > 0) {
      const row = document.createElement("div");
      row.classList.add("package-item");
      row.innerHTML = `
        <span>ğŸ“¦ ${type.charAt(0).toUpperCase() + type.slice(1)} (x${count})</span>
        <span>${descriptions[type]}</span>
      `;
      container.appendChild(row);
    }
  });
}

/* -------------------------------------------------------
   â­  LOAD COMPANY INFO
------------------------------------------------------- */
async function loadCompany() {
  const { id, small, medium, large } = getParams();
  const packages = { small, medium, large };

  // Render mini breakdown
  renderPackageBreakdown(packages);

  // Fetch companies
  const res = await fetch("http://127.0.0.1:8080/get_moving_companies");
  const data = await res.json();
  const c = data.find(x => x.id == id);

  if (!c) {
    alert("Company not found");
    return;
  }

  // Fill info
  document.getElementById("companyName").innerText = c.name;
  document.getElementById("companyCIF").innerText = c.cif;
  document.getElementById("companyBaseFee").innerText = c.base_fee + " â‚¬";
  document.getElementById("companyCity").innerText = c.location;
  document.getElementById("companyTime").innerText = c.estimated_time_days + " days";
  document.getElementById("companyWeight").innerText = c.max_weight_kg + " kg";
  document.getElementById("companyRating").innerText = c.rating;
  document.getElementById("companyRatingStars").innerHTML = renderStars(c.rating);

  // Prices
  document.getElementById("priceSmall").innerText = c.price_small_package + " â‚¬";
  document.getElementById("priceMedium").innerText = c.price_medium_package + " â‚¬";
  document.getElementById("priceLarge").innerText = c.price_large_package + " â‚¬";
  document.getElementById("priceSolo").innerText = c.price_solo_traslado + " â‚¬";
  document.getElementById("priceMudanza").innerText = c.price_mudanza + " â‚¬";
  document.getElementById("priceMudanzaCompleta").innerText = c.price_mudanza_completa + " â‚¬";

  // Contact
  document.getElementById("companyPhone").innerText = c.phone ?? "Not available";
  document.getElementById("companyEmail").innerText = c.email ?? "Not available";

  /* ---------- â­ LOAD REVIEWS ---------- */
  const reviews = c.reviews ?? [
    { stars: 4.5, author: "Ana LÃ³pez", text: "Great service, everything arrived perfectly." },
    { stars: 5, author: "Carlos FernÃ¡ndez", text: "Amazing staff and fast moving service." },
    { stars: 3.5, author: "MarÃ­a Ruiz", text: "Good but could improve on timing." }
  ];

  document.getElementById("reviewsList").innerHTML = reviews.map(r => `
    <div class="review-card">
      <div class="review-stars">${renderStars(r.stars)}</div>
      <div class="review-author">${r.author}</div>
      <div class="review-preview">${r.text}</div>
    </div>
  `).join("");

  /* ---------- â­ LOAD GALLERY ---------- */
  document.getElementById("companyImages").innerHTML = `
    <img src="../assets/images/almacen1.jpg">
    <img src="../assets/images/mudanza1.jpg">
    <img src="../assets/images/empresa1.jpg">
  `;
}

/* -------------------------------------------------------
   â­  LOAD ESTIMATE CARD
------------------------------------------------------- */
async function loadEstimateCard() {
  const { from, to, small, medium, large, type } = getParams();

  const totalPackages = small + medium + large;

  // Show route & type
  document.getElementById("estimateRoute").textContent = `${from} â†’ ${to}`;
  document.getElementById("estimatePackages").textContent = totalPackages;
  document.getElementById("estimateType").textContent = type;

  // Call backend to calculate distance
  const res = await fetch(`http://127.0.0.1:8080/calc_distance?from=${from}&to=${to}`);
  const data = await res.json();

  if (!data.distance_km) {
    document.getElementById("estimateDistance").textContent = "N/A";
    return;
  }

  const distance = data.distance_km;
  document.getElementById("estimateDistance").textContent = `${distance} km`;

  // Get base fee
  const base = Number(document.getElementById("companyBaseFee").innerText.replace("â‚¬", ""));

  // Example formulas (adjust as needed)
  const packageCost = (small * 5) + (medium * 8) + (large * 12);
  const distanceCost = distance * 0.40;
  const typeMultiplier = type === "complete" ? 2.2 : type === "mudanza" ? 1.6 : 1.2;

  const total = Math.round((base + packageCost + distanceCost) * typeMultiplier);

  document.getElementById("estimatePrice").textContent = `${total} â‚¬`;
}

/* -------------------------------------------------------
   â­ SEND MESSAGE
------------------------------------------------------- */
function sendMessage() {
  const msg = document.getElementById("contactMessage").value.trim();
  if (!msg) {
    alert("Please write a message.");
    return;
  }
  alert("Your message has been sent! âœ‰ï¸");
}

/* -------------------------------------------------------
   â­ INIT ON PAGE LOAD
------------------------------------------------------- */
loadCompany();
loadEstimateCard();
  </script>

</body>
</html>
