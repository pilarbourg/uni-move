<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Details</title>
  <link rel="stylesheet" href="../css/company.css" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
   
</head>

<body>

  <div class="overlay">

    <!-- â­ BOTÃ“N + TÃTULO -->
    <div class="button-title-container">
      <button class="back-btn" onclick="history.back()">â† Back</button>
      <h1 class="company-title" id="companyName">Loading...</h1>
    </div>

    <!-- â­ CONTENEDOR PRINCIPAL -->
    <div class="company-wrapper">
      <div class="company-main-card">

        <!-- â­ BLOQUE 1: DETAILS + PRICING + GALLERY -->
        <div class="details-split">

          <!-- LEFT COLUMN -->
          <div class="left-column">

            <div class="details-grid">

              <!-- â­ COMPANY DETAILS MINI CARD -->
              <div class="mini-card">
                <h3 class="mini-title">Company Details</h3>

                <div class="details-center">
                  <div class="detail-row"><span>ğŸ“„</span> <strong>CIF:</strong> <span id="companyCIF"></span></div>
                  <div class="detail-row"><span>ğŸ’¶</span> <strong>Base fee:</strong> <span id="companyBaseFee"></span></div>
                  <div class="detail-row"><span>ğŸ“</span> <strong>City:</strong> <span id="companyCity"></span></div>
                  <div class="detail-row"><span>â³</span> <strong>Estimated:</strong> <span id="companyTime"></span></div>
                  <div class="detail-row"><span>ğŸ‹ï¸</span> <strong>Max weight:</strong> <span id="companyWeight"></span></div>
                  <div class="detail-row"><span>â­</span> <strong>Rating:</strong> <span id="companyRatingStars"></span> <span id="companyRating"></span></div>
                </div>
              </div>

              <!-- â­ PRICING MINI CARD -->
              <div class="mini-card">
                <h3 class="mini-title">Pricing</h3>

                <div class="details-center">
                  <div class="detail-row"><span>ğŸ“¦</span> <strong>Small package:</strong> <span id="priceSmall"></span></div>
                  <div class="detail-row"><span>ğŸ“¦</span> <strong>Medium package:</strong> <span id="priceMedium"></span></div>
                  <div class="detail-row"><span>ğŸ“¦</span> <strong>Large package:</strong> <span id="priceLarge"></span></div>
                  <div class="detail-row"><span>ğŸšš</span> <strong>Solo traslado:</strong> <span id="priceSolo"></span></div>
                  <div class="detail-row"><span>ğŸ“¤</span> <strong>Mudanza:</strong> <span id="priceMudanza"></span></div>
                  <div class="detail-row"><span>ğŸ </span> <strong>Mudanza completa:</strong> <span id="priceMudanzaCompleta"></span></div>
                </div>
              </div>

            </div> <!-- end details-grid -->
          </div> <!-- end left column -->

          <!-- RIGHT COLUMN: GALLERY -->
          <div class="right-column">
            <h3 class="gallery-tittle">Image Gallery</h3>
            <div class="gallery" id="companyImages"></div>
          </div>

        </div> <!-- end details-split -->


        <!-- â­ BLOQUE 2: ESTIMATED COST -->
        <div class="estimate-card">
          <h2 class="estimate-title">Estimated Move Cost</h2>

         <div class="estimate-row">
          <h5 class="estimate-label">ğŸ”œ Origin â†’ Destination:</h5>
          <span id="estimateRoute">Loading...</span>
          </div>

          <div class="estimate-row">
          <h5 class="estimate-label">â†”ï¸ Total distance:</h5>
          <span id="estimateDistance">- km</span>
          </div>

          <div class="estimate-row">
          <h5 class="estimate-label">ğŸ“¥ Selected packages:</h5>
          <span id="estimatePackages">-</span>
         </div>

          <div class="package-breakdown-card">
          <h5 class="pb-title">Package Details</h5>
          <div id="packageBreakdownList"></div>
         </div>

         <div class="estimate-row">
          <h5 class="estimate-label">ğŸ‘£ Move type:</h5>
          <span id="estimateType">-</span>
         </div>

      </div>


        <!-- â­ BLOQUE 3: REVIEWS -->
        <h3 class="subsection">Reviews</h3>
        <div class="reviews-section" id="reviewsList"></div>


        <!-- â­ BLOQUE 4: CONTACT -->
        <h3 class="subsection">Contact</h3>
        <div class="contact-section">
          <div class="contact-info">
            <p><strong>Phone:</strong> <span id="companyPhone"></span></p>
            <p><strong>Email:</strong> <span id="companyEmail"></span></p>
          </div>

          <textarea class="contact-message" id="contactMessage" placeholder="Write your message..."></textarea>

          <button class="contact-send-btn" onclick="sendMessage()">Send Message</button>
        </div>

      </div> <!-- end main-card -->
    </div> <!-- end wrapper -->

  </div> <!-- end overlay -->


</body>

  <script>
    // Extraer ID de la URL
    async function loadCompany() {
    const params = new URLSearchParams(window.location.search);
    const companyId = params.get("id");
    const small = Number(params.get("small"));
    const medium = Number(params.get("medium"));
    const large = Number(params.get("large"));
    const type = params.get("type");
    const packages = { small, medium, large };
  
    renderPackageBreakdown(packages);

    const res = await fetch("http://127.0.0.1:8080/get_moving_companies");
    const companies = await res.json();
    const c = companies.find(x => x.id == companyId);

    document.getElementById("companyName").innerText = c.name;
    document.getElementById("companyCIF").innerText = c.cif;
    document.getElementById("companyBaseFee").innerText = c.base_fee + " â‚¬";
    document.getElementById("companyCity").innerText = c.location;
    document.getElementById("companyTime").innerText = c.estimated_time_days + " days";
    document.getElementById("companyWeight").innerText = c.max_weight_kg + " kg";
    document.getElementById("companyRating").innerText = c.rating;
    document.getElementById("companyRatingStars").innerHTML = renderStars(c.rating);

    document.getElementById("priceSmall").innerText = c.price_small_package + " â‚¬";
    document.getElementById("priceMedium").innerText = c.price_medium_package + " â‚¬";
    document.getElementById("priceLarge").innerText = c.price_large_package + " â‚¬";
    document.getElementById("priceSolo").innerText = c.price_solo_traslado + " â‚¬";
    document.getElementById("priceMudanza").innerText = c.price_mudanza + " â‚¬";
    document.getElementById("priceMudanzaCompleta").innerText = c.price_mudanza_completa + " â‚¬";

    document.getElementById("companyPhone").innerText = c.phone ?? "Not available";
    document.getElementById("companyEmail").innerText = c.email ?? "Not available";
// ----------- â­ LOAD REVIEWS (from CSV / backend) -----------
    const reviewsList = document.getElementById("reviewsList");
    //TODO: fetch reviews from backend
    // You will eventually fetch these from /get_reviews?id=...
    // For now, using mock data:
    const reviews = c.reviews ?? [
      { stars: 4.5, author: "Ana LÃ³pez", text: "Great service, everything arrived perfectly." },
      { stars: 5, author: "Carlos FernÃ¡ndez", text: "Amazing staff and fast moving service. Highly recommended." },
      { stars: 3.5, author: "MarÃ­a Ruiz", text: "Good but could improve on timing." }
    ];

function renderStars(n) {
  let stars = "";
  const full = Math.floor(n);
  const half = n % 1 >= 0.5;
  for (let i = 0; i < full; i++) stars += "â˜…";
  if (half) stars += "â˜†";
  return stars;
}

reviewsList.innerHTML = reviews.map(r => `
  <div class="review-card">
    <div class="review-stars">${renderStars(r.stars)}</div>
    <div class="review-author">${r.author}</div>
    <div class="review-preview">${r.text}</div>
  </div>
`).join("");
    // GALLERY (ejemplo con imÃ¡genes guardadas en BBDD)
    const gallery = document.getElementById("companyImages");
    // En tu BBDD necesitarÃ¡s agregar las rutas; aquÃ­ pongo 3 dummy images:
    gallery.innerHTML = `
        <img src="../assets/images/almacen1.jpg">
        <img src="../assets/images/mudanza1.jpg">
        <img src="../assets/images/empresa1.jpg">
    `;
    }
    function sendMessage() {
  const msg = document.getElementById("contactMessage").value.trim();
  if (!msg) {
    alert("Please write a message.");
    return;
  }

  alert("Your message has been sent âœ‰ï¸");
}

function renderPackageBreakdown(packages) {
  const container = document.getElementById("packageBreakdownList");
  container.innerHTML = "";  // limpiar

  const descriptions = {
    small: "up to 25 kg",
    medium: "25â€“50 kg",
    large: "over 50 kg"
  };

  Object.entries(packages).forEach(([type, count]) => {
    if (count > 0) {
      const div = document.createElement("div");
      div.classList.add("package-item");
      div.innerHTML = `
        <span>ğŸ“¦ ${type.charAt(0).toUpperCase() + type.slice(1)} package (x${count})</span>
        <span>${descriptions[type]}</span>
      `;
      container.appendChild(div);
    }
  });
}

function loadEstimateCard() {
  const params = new URLSearchParams(window.location.search);

  const from = params.get("from");
  const to = params.get("to");
  const small = Number(params.get("small"));
  const medium = Number(params.get("medium"));
  const large = Number(params.get("large"));
  const packages = small + medium + large;
  const type = params.get("type");

  // Mostrar en la card
  document.getElementById("estimateRoute").textContent = `${from} â†’ ${to}`;
  document.getElementById("estimatePackages").textContent = packages;
  document.getElementById("estimateType").textContent = type;

  // Calcular distancia con API OSRM o precalculada por el backend
  fetch(`http://127.0.0.1:8080/calc_distance?from=${from}&to=${to}`)
    .then(res => res.json())
    .then(data => {

      const distance = data.distance_km;
      document.getElementById("estimateDistance").textContent = `${distance} km`;

      // FÃ³rmula ejemplo (ajÃºstala a tu backend):
      let base = Number(document.getElementById("companyBaseFee").innerText.replace("â‚¬",""));

      let packageCost = packages * 5; // 5â‚¬ por paquete, ejemplo
      let typeMultiplier = type === "complete" ? 2.2 : type === "large" ? 1.6 : 1.2;
      let distanceCost = distance * 0.4; // 0.40â‚¬ por km, ejemplo

      const total = Math.round((base + packageCost + distanceCost) * typeMultiplier);

      document.getElementById("estimatePrice").textContent = `${total} â‚¬`;
      // Ejemplo: packages=small:2,medium:1,large:0
  const rawPackages = params.get("packages");

  // Convertir a objeto
  const pkg = rawPackages.split(",").reduce((acc, item) => {
    const [type, count] = item.split(":");
    acc[type] = Number(count);
    return acc;
  }, { small: 0, medium: 0, large: 0 });

  // Mostrar nÃºmero total
  document.getElementById("estimatePackages").textContent =
    pkg.small + pkg.medium + pkg.large;

  // Render mini-card
  renderPackageBreakdown(pkg);
    });
}

loadEstimateCard();


    loadCompany();
  </script>

</body>
</html>
