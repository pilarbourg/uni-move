<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniMove | Moving Companies</title>
  <link rel="stylesheet" href="../css/moving_companies_list.css" />

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

</head>

<body>

  <!-- ---------- NAVBAR ---------- -->
  <nav class="navbar">
    <div class="logo">
      <img src="../assets/svgs/logo.svg" width="36"> UniMove
    </div>
  </nav>

  <!-- ---------- HERO ---------- -->
  <section class="hero-section">
    <div class="hero-overlay">
      <h1>Moving Companies in Spain</h1>
    </div>
  </section>
<!-- ---------- SEARCH BOX FORM ---------- -->
<section class="moving-form-container">
  <div class="moving-form">
    <h2>Plan your move</h2>

    <div class="form-group">
      <label>From:</label>
      <input type="text" id="fromCity" placeholder="Madrid, Barcelona, Valencia...">
    </div>

    <div class="form-group">
      <label>To:</label>
      <input type="text" id="toCity" placeholder="Sevilla, Bilbao, Zaragoza...">
    </div>

    <div class="form-group">
      <label>Moving date:</label>
      <input type="date" id="moveDate">
    </div>

    <div class="form-section">
      <h3 class="form-subtitle">Packages</h3>

      <div class="package-grid">
        <div class="package-item">
          <label>Small packages:</label>
          <input type="number" id="smallPackages" min="0" value="0">
        </div>

        <div class="package-item">
          <label>Medium packages:</label>
          <input type="number" id="mediumPackages" min="0" value="0">
        </div>

        <div class="package-item">
          <label>Large packages:</label>
          <input type="number" id="largePackages" min="0" value="0">
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="form-subtitle">Move type</h3>

      <select id="moveType" class="move-type-select">
        <option value="only transport">Solo traslado</option>
        <option value="half move">Mudanza</option>
        <option value="complete move">Mudanza completa</option>
      </select>
    </div>

    <button class="plan-move-btn" onclick="planMove()">Search Companies</button>
  </div>
</section>

<!-- ---------- PAGE CONTENT ---------- -->
<div class="page-content" id="resultsSection" style="display:none;">
  <h2>Available Companies</h2>
  <div class="filter-container">
  <button class="filter-btn">Filter ⏷</button>
  <div class="filter-menu" id="filterMenu">
    <div class="filter-option" onclick="applyFilter('price')">Sort by price</div>
    <div class="filter-option" onclick="applyFilter('rating')">Sort by rating</div>
  </div>
  <div id="companies" class="companies-grid"></div>
</div>

  <script>

  /* ------------------------------------------------------------------
    GLOBAL STATE (cache de compañías + distancia + paquetes)
------------------------------------------------------------------ */
let loadedCompanies = [];
let cachedDistance = 0;
let packageCounts = { small: 0, medium: 0, large: 0 };


/* ------------------------------------------------------------------
    FETCH COMPANIES + PREPARE CALCULATIONS
------------------------------------------------------------------ */
async function fetchCompanies() {
  try {
    const res = await fetch("http://127.0.0.1:8080/get_moving_companies");
    const companies = await res.json();

    // Guardar en memoria
    loadedCompanies = companies;

    // Leer datos del formulario
    const from = document.getElementById("fromCity").value.trim();
    const to = document.getElementById("toCity").value.trim();

    packageCounts.small = Number(document.getElementById("smallPackages").value);
    packageCounts.medium = Number(document.getElementById("mediumPackages").value);
    packageCounts.large = Number(document.getElementById("largePackages").value);

    // Get distance
    const distanceRes = await fetch(
      `http://127.0.0.1:8080/calc_distance?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`
    );
    const distanceData = await distanceRes.json();
    cachedDistance = distanceData.distance_km ?? 0;
    console.log("Distance (km):", cachedDistance);

    // Calcular precios estimados
    loadedCompanies.forEach(c => {
      const base = c.base_fee ?? 0;
      const km = c.km_price ?? 0;
      console.log("KM Price:", km * cachedDistance);
      const pSmall = c.price_small_package ?? 0;
      const pMedium = c.price_medium_package ?? 0;
      const pLarge = c.price_large_package ?? 0;

      c.estimatedPrice =
        base +
        (packageCounts.small * pSmall) +
        (packageCounts.medium * pMedium) +
        (packageCounts.large * pLarge) +
        (km * cachedDistance);
    });

    // Mostrar por defecto (orden por precio)
    applyFilter("price");

  } catch (error) {
    console.error("❌ Error fetching companies:", error);
  }
}


/* ------------------------------------------------------------------
    APPLY FILTER (price | rating)
------------------------------------------------------------------ */
function applyFilter(criteria) {
  let list = [...loadedCompanies];

  if (criteria === "price") {
    list.sort((a, b) => a.estimatedPrice - b.estimatedPrice);
  }

  if (criteria === "rating") {
    list.sort((a, b) => (b.rating ?? 0) - (a.rating ?? 0));
  }

  renderCompanies(list);
}


/* ------------------------------------------------------------------
    RENDER COMPANIES (solo dibuja tarjetas)
------------------------------------------------------------------ */
function renderCompanies(companies) {
  const container = document.getElementById("companies");

  container.innerHTML = companies
    .map(c => `
      <div class="company-card" onclick="openCompany(${c.id})">

        <h2>${c.name}</h2>

        <p><strong>City:</strong> ${c.location ?? "Unknown"}</p>

        <p><strong>Rating:</strong> 
          ${c.rating ? c.rating + " ⭐" : "N/A"}
        </p>

        <p><strong>Starting price:</strong> 
          ${c.base_fee ? c.base_fee + " €" : "N/A"}
        </p>

        <p><strong>Estimated price:</strong> 
          ${c.estimatedPrice.toFixed(2)} €
        </p>

      </div>
    `)
    .join("");
}

  /* --------------------------
        OPEN COMPANY DETAILS
  --------------------------- */
  function openCompany(id) {
    const from = document.getElementById("fromCity").value;
    const to = document.getElementById("toCity").value;
    const date = document.getElementById("moveDate").value;

    const small = document.getElementById("smallPackages").value;
    const medium = document.getElementById("mediumPackages").value;
    const large = document.getElementById("largePackages").value;

    const type = document.getElementById("moveType").value;

    const query = `?id=${id}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&date=${date}&small=${small}&medium=${medium}&large=${large}&type=${type}`;

    window.location.href = `company.html${query}`;
  }



  /* --------------------------
       VALIDACIÓN BACKEND API
  --------------------------- */
  async function validateAddressBackend(city) {
    try {
      const res = await fetch(
        `http://127.0.0.1:8080/validate_address?city=${encodeURIComponent(city)}`
      );

      if (!res.ok) {
        console.error("❌ Backend error validate_address");
        return false;
      }

      const data = await res.json();
      return data.valid === true;

    } catch (e) {
      console.error("❌ Cannot validate address:", e);
      return false;
    }
  }




  /* --------------------------
         VALIDAR FECHA
  --------------------------- */
  function validateDate(date) {
    const selected = new Date(date);
    const today = new Date();
    today.setHours(0,0,0,0);

    return selected >= today;
  }




  /* --------------------------
       VALIDAR PAQUETES
  --------------------------- */
  function validatePackages(small, medium, large) {
    return (
      Number.isInteger(small) &&
      Number.isInteger(medium) &&
      Number.isInteger(large) &&
      small >= 0 &&
      medium >= 0 &&
      large >= 0
    );
  }




  /* --------------------------
            PLAN MOVE
  --------------------------- */
  async function planMove() {

    const from = document.getElementById("fromCity").value.trim();
    const to = document.getElementById("toCity").value.trim();
    const date = document.getElementById("moveDate").value;

    if (!from || !to || !date) {
      alert("Please fill in all fields.");
      return;
    }

    /* VALIDAR DIRECCIONES */
    const validFrom = await validateAddressBackend(from);
    if (!validFrom) {
      alert("Please enter a valid origin address.");
      return;
    }

    const validTo = await validateAddressBackend(to);
    if (!validTo) {
      alert("Please enter a valid destination address.");
      return;
    }

    /* VALIDAR FECHA */
    if (!validateDate(date)) {
      alert("Please select a valid moving date.");
      return;
    }

    /* VALIDAR PAQUETES */
    const small = parseInt(document.getElementById("smallPackages").value);
    const medium = parseInt(document.getElementById("mediumPackages").value);
    const large = parseInt(document.getElementById("largePackages").value);

    if (!validatePackages(small, medium, large)) {
      alert("Please enter valid package quantities.");
      return;
    }

    /* MOSTRAR RESULTADOS */
    document.getElementById("resultsSection").style.display = "block";

    /* CARGAR COMPAÑÍAS */
    fetchCompanies();
  }

  </script>

</body>
</html>
